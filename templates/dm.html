<!DOCTYPE html>
<html lang="kr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <title>DM-{{ counterpartId }}</title>
  </head>

  <body data-chat-room-id="{{ chat_room.chatRoomId }}">
    <header class="base_header">
      <a href="/chatting_list" class="base_header__icon base_header__back">
        <i class="fa-solid fa-chevron-left fa-xl" style="color: #242424"></i>
      </a>
      <div class="base_header__dm">
        <img
          class="dm_profile__img"
          src="{{ url_for('static', filename=counterpartImg) }}"
          alt="프로필 사진"
        />
        <h2 class="base_header__title">{{ counterpartId }}</h2>
      </div>
      <div class="base_header__icon">
        <!--레이아웃 배치용-->
      </div>
    </header>
    <div class="review_item">
      <div class="review_img__box">
        <img
          class="review_item__img"
          src="{{ url_for('static', filename=chat_room.imgPath) }}"
          alt="상품 이미지"
        />
      </div>
      <div class="review_item__content">
        <p class="review_item__title">{{ chat_room.itemName }}</p>
        <p class="review_item__price commas_price">
          {{ chat_room.itemPrice }}원
        </p>
      </div>
    </div>

    <main class="dm_section" id="chat-window"></main>

    <footer class="dm_footer">
      <form class="dm_reply" action="">
        <div class="dm_reply__column" id="dm__plus_btn">
          <i
            id="dm_reply__plus"
            class="fa-solid fa-circle-plus fa-lg"
            style="color: #7a7a7a"
          ></i>
        </div>

        <div class="dm_reply__column">
          <input
            id="dm_reply__input"
            type="text"
            placeholder="메시지를 입력하세요."
          />
        </div>
        <div class="dm_reply__column">
          <button id="dm_reply__send">
            <img src="static/images/send-arrow.png" alt="버튼" />
          </button>
        </div>
        <script>
          document
            .getElementById("dm_reply__send")
            .addEventListener("click", function (event) {
              event.preventDefault();
              var messageText =
                document.getElementById("dm_reply__input").value;
              var senderId = '{{ session["id"] }}';
              var chatRoomId = "{{ chat_room.chatRoomId }}";
              //시간 생성
              var timestamp = new Date();

              if (messageText.trim() === "") {
                alert("메시지를 입력해주세요.");
                return;
              }

              var data = {
                senderId: senderId,
                message: messageText,
                chatRoomId: chatRoomId,
                timestamp: timestamp,
              };

              fetch("/send_msg", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === "success") {
                    // 메시지가 성공적으로 보내졌으므로, 텍스트 입력 필드를 비움
                    document.getElementById("dm_reply__input").value = "";
                  }
                })
                .catch((error) => {
                  console.error("메시지 전송 오류:", error);
                });
            });
        </script>
      </form>
      <div class="dm_function" id="dm_function__menu">
        <div class="dm_function__icon">
          <div class="dm_icon__box" id="dm_function_emoji">
            <i class="fa-regular fa-face-smile"></i>
          </div>
          <span>이모티콘</span>
        </div>
        <div class="dm_function__icon">
          <div class="dm_icon__box" id="dm_function_img">
            <i class="fa-regular fa-image"></i>
          </div>
          <span>사진</span>
        </div>
        <div class="dm_function__icon">
          <div class="dm_icon__box" id="dm_function_camera">
            <i class="fa-solid fa-camera"></i>
          </div>
          <span>카메라</span>
        </div>
        <div class="dm_function__icon">
          <div class="dm_icon__box" id="dm_function_place">
            <i class="fa-solid fa-location-dot"></i>
          </div>
          <span>장소</span>
        </div>
        {% if session['id'] == chat_room.sellerId %}
        <div class="dm_function__icon">
          <div class="dm_icon__box" id="dm_function_complete">
            <i class="fa-solid fa-circle-check"></i>
          </div>
          <span>거래완료</span>
        </div>
        {% endif %}
        <script>
          document
            .getElementById("dm_function_complete")
            .addEventListener("click", function () {
              var chatRoomId = "{{ chat_room.chatRoomId }}";

              var xhr = new XMLHttpRequest();
              xhr.open("POST", "/complete/" + chatRoomId, true);
              xhr.setRequestHeader("Content-Type", "application/json");

              xhr.onload = function () {
                if (xhr.status === 200) {
                  alert("거래가 완료되었습니다!");
                } else {
                  alert("오류가 발생했습니다: " + xhr.status);
                }
              };

              xhr.send(JSON.stringify({ chatRoomId: chatRoomId }));
            });
        </script>
        <div class="dm_function__icon"></div>
        <div class="dm_function__icon"></div>
        <div class="dm_function__icon"></div>
      </div>
    </footer>
    <!-- Firebase 스크립트와 초기화 코드 -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>

    <script>
              var firebaseConfig = {
                  apiKey: 'AIzaSyDWz1_ZttmWjc1IzQRI8wMAe-IqeYDzark',
                  authDomain: 'ong-market.firebaseapp.com',
                  databaseURL: 'https://ong-market-default-rtdb.firebaseio.com',
                  projectId: 'ong-market',
                  storageBucket: 'ong-market.appspot.com',
                  messagingSenderId: '464409088344',
                  appId: '1:464409088344:web:bd00bf2f298988db2c552d',
              };
              firebase.initializeApp(firebaseConfig);

              var chatRoomId = document.body.getAttribute('data-chat-room-id');
              var chatRoomRef = firebase.database().ref('chats/' + chatRoomId);
              var messageRef = chatRoomRef.child('messages').orderByChild('timestamp');
              var completeRef = chatRoomRef.child('complete');

              var sessionId = '{{ session["id"] }}';
              var sellerId = '{{ chat_room.sellerId }}';

              // 메시지에 대한 이벤트 리스너
              messageRef.on('child_added', function (snaphot) {
                  var message = snaphot.val();
                  addMessageToChatWindow(message);
              });

              // 거래 완료 상태 감지
              completeRef.on('value', function (snaphot) {
                  if (snaphot.val() === true) {
                      if (sessionId === sellerId) {
                          // 판매자 완료 메시지 - 리뷰 보기
                          addCompleteMessageForSeller();
                      } else {
                          // 구매자 완료 메시지 - 리뷰 쓰기
                          addCompleteMessageForBuyer();
                      }
                  }
              });

              function addMessageToChatWindow(message) {
                  var chatWindow = document.getElementById('chat-window');
                  var messageElement = document.createElement('div');
                  var senderIsSessionUser = message.senderId === '{{ session["id"] }}';

                  messageElement.className = senderIsSessionUser
                      ? 'dm_section__line dm_section__me'
                      : 'dm_section__line dm_section__you';

                  if (!senderIsSessionUser) {
                      // 상대방의 프로필 이미지를 추가합니다.
                      var imgElement = document.createElement('img');
                      imgElement.className = 'dm_profile__img';
                      imgElement.src = '{{ url_for("static", filename=counterpartImg) }}'; // 프로필 이미지 URL
                      imgElement.alt = '프로필 사진';
                      messageElement.appendChild(imgElement);
                  }

                  // 메시지 텍스트를 추가합니다.
                  var messageTextElement = document.createElement('span');
                  messageTextElement.className = 'dm_msg';
                  messageTextElement.innerHTML = message.text;
                  messageElement.appendChild(messageTextElement);

                  // 메시지 타임스탬프를 추가합니다.
                  var timestampElement = document.createElement('span');
                  timestampElement.className = 'dm_time';

                  var timestampDate = new Date(message.timestamp);

                  //시간 format 적용을 위한 코드
                  var year = timestampDate.toLocaleString("en-GB", { year: "numeric",});
                  console.log(year);
                  var month = timestampDate.toLocaleString("en-GB", {month: "2-digit"});
                  var day = timestampDate.toLocaleString("en-GB", { day: "2-digit" });
                  var hour = timestampDate.toLocaleString("en-GB", {
                    hour: "2-digit",
                    hour12: false,
                  });
                  var minute = timestampDate.toLocaleString("en-GB", {
                    minute: "2-digit",
                  });

                  var formattedTimestamp = `${year}-${month}-${day} ${hour}:${minute}`;

                  timestampElement.innerHTML = formattedTimestamp;
                  messageElement.appendChild(timestampElement);

                  chatWindow.appendChild(messageElement);
              }

      function addCompleteMessageForSeller() {
          var chatWindow = document.getElementById('chat-window');

          // 거래 완료 메시지를 생성합니다.
          var infoDiv = document.createElement('div');
          infoDiv.className = 'dm_info';

          var contentDiv = document.createElement('div');
          contentDiv.className = 'dm_info__content';

          var titleP = document.createElement('p');
          titleP.className = 'dm_info__content-title';
          titleP.textContent = '안내';

          var textP = document.createElement('p');
          textP.className = 'dm_info__contenttxt';
          textP.textContent = '거래가 완료되었어요!';

          var reviewLink = document.createElement('a');
          reviewLink.className = 'dm_info__btn';
          reviewLink.href = '/review_detail/' + {{ chat_room.itemId }};
          reviewLink.textContent = '리뷰 보기';

          contentDiv.appendChild(titleP);
          contentDiv.appendChild(textP);
          infoDiv.appendChild(contentDiv);
          infoDiv.appendChild(reviewLink);

          chatWindow.appendChild(infoDiv);
      }

              function addCompleteMessageForBuyer() {
         var chatWindow = document.getElementById('chat-window');

          // 거래 완료 메시지를 생성합니다.
          var infoDiv = document.createElement('div');
          infoDiv.className = 'dm_info';

          var contentDiv = document.createElement('div');
          contentDiv.className = 'dm_info__content';

          var titleP = document.createElement('p');
          titleP.className = 'dm_info__content-title';
          titleP.textContent = '안내';

          var textP = document.createElement('p');
          textP.className = 'dm_info__contenttxt';
          textP.textContent = '거래가 완료되었어요! 리뷰를 남겨주세요.';

          var reviewLink = document.createElement('a');
          reviewLink.className = 'dm_info__btn';
          reviewLink.href = '/reg_review/' + {{ chat_room.itemId }};
          reviewLink.textContent = '리뷰 작성하기';

          contentDiv.appendChild(titleP);
          contentDiv.appendChild(textP);
          infoDiv.appendChild(contentDiv);
          infoDiv.appendChild(reviewLink);

          chatWindow.appendChild(infoDiv);
      }
    </script>
  </body>
  <script
    src="https://kit.fontawesome.com/afee348a73.js"
    crossorigin="anonymous"
  ></script>
  <script src="../static/screens/dm.js"></script>
  <script src="../static/components/commas_to_price.js"></script>
</html>
