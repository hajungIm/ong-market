<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>채팅 목록</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='chatting_list_style.css') }}"
    />
  </head>
  <body>
    <header class="base_header">
      <div class="base_header__icon">
        <!--레이아웃 배치용-->
      </div>
      <div>
        <h2 class="base_header__title">채팅 목록</h2>
      </div>
      <div class="base_header__icon">
        <!--레이아웃 배치용-->
      </div>
    </header>
    <main class="list_page_box">
      {% for chat_room in chat_rooms %}
      <a
        href="{{ url_for('chat_room_page', chat_room_id=chat_room.chatRoomId) }}"
      >
        <div class="item_box1">
          <div class="item_selection">
            <div
              class="item_box1__img"
              style="border-radius: 9999px; width: 60px; height: 60px"
            >
              <img
                src="{% if chat_room.sellerId != session['id'] %}{{ url_for('static', filename=chat_room.sellerImg) }}{% else %}{{ url_for('static', filename=chat_room.buyerImg) }}{% endif %}"
                alt="profile"
              />
            </div>

            <!-- 채팅 정보 -->
            <div class="item_box1__info">
              <div class="item_box1__upload" style="margin-bottom: 5px">
                {% if chat_room.sellerId != session['id'] %}
                <p class="item_box1__seller">{{ chat_room.sellerId }}</p>
                {% else %}
                <p class="item_box1__seller">{{ chat_room.buyerId }}</p>
                {% endif %}
                <p class="item_box1__date chat timeformat">
                  {{ chat_room.lastTimestamp }}
                </p>
              </div>
              <!-- 마지막 메시지 텍스트 -->
              <p class="last_message maxLength">
                {{ chat_room.lastMessageText }}
              </p>
            </div>
          </div>

          <!-- 채팅방의 상품 이미지 (예시로 static images 사용) -->
          <div
            class="item_box1__img"
            style="width: 70px; height: 70px; display: flex"
          >
            <img
              src="{{ url_for('static', filename=chat_room.imgPath) }}"
              alt="item image"
            />
          </div>
        </div>
      </a>
      {% endfor %}
    </main>
      
      <p>
      [ new chat 알림 확인을 위한 임시 표기 코드 ]<br>
      {{ session['newChat'] if session['newChat'] else 'no new chat' }}
    </p>
      
    {% include 'nav_bar.html' %}
  </body>
  <script
    src="https://kit.fontawesome.com/afee348a73.js"
    crossorigin="anonymous"
  ></script>

<script src="{{ url_for('static', filename='components/timestamp.js') }}"></script>
<script src="{{ url_for('static', filename='components/textMaxLength.js') }}"></script>
<!-- Firebase 스크립트와 초기화 코드 -->
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
<script>

  var firebaseConfig = {
    apiKey: 'AIzaSyDWz1_ZttmWjc1IzQRI8wMAe-IqeYDzark',
    authDomain: 'ong-market.firebaseapp.com',
    databaseURL: 'https://ong-market-default-rtdb.firebaseio.com',
    projectId: 'ong-market',
    storageBucket: 'ong-market.appspot.com',
    messagingSenderId: '464409088344',
    appId: '1:464409088344:web:bd00bf2f298988db2c552d',
  };
  firebase.initializeApp(firebaseConfig);

  // 새 채팅방 생성 여부 감지
  var userKey = '{{ user_key }}';
  var userChatRoomsRef = firebase.database().ref("user/" + userKey + "/chatRooms");
  userChatRoomsRef.on('child_added', function (snapshot) {
    fetch('/notify_new_chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
      .then(response => response.json())
      .then(data => {
        console.log('Session updated with new chat room flag');
      })
      .catch(error => console.error('Error:', error));
  });

  // 기존 채팅방 새로운 메시지 감지
  var chatRoomIds = {{ chat_room_ids| tojson }};
  function listenToChatRoomMessage(chatRoomId) {
    var messagesRef = firebase.database().ref("chats/" + chatRoomId + "/messages");
    messagesRef.on('child_added', function (snapshot) {
      fetch('/notify_new_chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
        .then(response => response.json())
        .then(data => {
          console.log('Session updated with new chat room flag');
        })
        .catch(error => console.error('Error:', error));
    });
  }

  chatRoomIds.forEach(function (chatRoomId) {
    listenToChatRoomMessage(chatRoomId);
  });
</script>
<script>
  var hasNewChat = {{ session['newChat']|default(False)|tojson|safe }};
  const alarmDot = document.getElementsByClassName("alarm_dot")[0];
  if (hasNewChat) {
    alarmDot.style.visibility = "visible";
  } else {
    alarmDot.style.visibility = "hidden";
  }

</script>
</html>
